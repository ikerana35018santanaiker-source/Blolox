<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blolox</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      margin: 0; 
      overflow: hidden; 
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .game-canvas { 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .game-card {
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .game-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }
    
    .game-card:hover::before {
      left: 100%;
    }
    
    .game-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    
    .friend-avatar {
      position: relative;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .friend-avatar:hover {
      transform: scale(1.1) rotate(5deg);
    }
    
    .friend-avatar::after {
      content: '';
      position: absolute;
      bottom: 0;
      right: 0;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 3px solid #1f2937;
    }
    
    .friend-avatar.online::after {
      background: #10b981;
      box-shadow: 0 0 10px #10b981;
      animation: pulse-green 2s infinite;
    }
    
    .friend-avatar.offline::after {
      background: #6b7280;
    }
    
    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 10px #10b981; }
      50% { box-shadow: 0 0 20px #10b981; }
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .btn-primary::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .btn-primary:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.5);
    }
    
    .notification-enter {
      animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes slideInRight {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .modal-backdrop { animation: fadeIn 0.3s; }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content { animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    input:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
    }
    
    .peer-id-box {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border: 2px solid #334155;
      position: relative;
      overflow: hidden;
    }
    
    .peer-id-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.2), transparent);
      animation: shimmer 3s infinite;
    }
    
    @keyframes shimmer { to { left: 100%; } }
    
    @keyframes blob {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(20px, -50px) scale(1.1); }
      50% { transform: translate(-20px, 20px) scale(0.9); }
      75% { transform: translate(50px, 50px) scale(1.05); }
    }
    
    .animate-blob { animation: blob 7s infinite; }
    .animation-delay-2000 { animation-delay: 2s; }
    .animation-delay-4000 { animation-delay: 4s; }
    
    .logo-text {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradient-shift 3s ease infinite;
      background-size: 200% 200%;
    }
    
    @keyframes gradient-shift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .chat-message {
      max-width: 70%;
      word-wrap: break-word;
    }
    
    .chat-message.mine {
      margin-left: auto;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }
    
    .chat-message.theirs {
      margin-right: auto;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .chat-media {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 8px;
    }
    
    .scrollbar-thin::-webkit-scrollbar { width: 8px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 10px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }
    
    .player-label {
      position: absolute;
      color: white;
      background: rgba(0,0,0,0.7);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      pointer-events: none;
      white-space: nowrap;
      border: 2px solid rgba(255,255,255,0.3);
    }
  </style>
</head>
<body>

<!-- Pantalla de Registro -->
<div id="registerScreen" class="flex items-center justify-center h-screen relative">
  <div class="absolute inset-0 overflow-hidden">
    <div class="absolute w-96 h-96 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob" style="top: 0%; left: 0%;"></div>
    <div class="absolute w-96 h-96 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000" style="top: 30%; right: 0%;"></div>
    <div class="absolute w-96 h-96 bg-pink-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000" style="bottom: 0%; left: 30%;"></div>
  </div>
  
  <div class="glass-effect p-10 rounded-3xl shadow-2xl w-[420px] relative z-10">
    <div class="text-center mb-8">
      <h1 class="text-6xl font-black mb-2 logo-text">Blolox</h1>
      <p class="text-gray-300 text-sm">Multiplayer Gaming Platform</p>
    </div>
    <input id="usernameInput" type="text" placeholder="Nombre de usuario" 
      class="w-full p-4 mb-6 bg-gray-800/50 rounded-xl border-2 border-gray-700 focus:border-blue-500 text-white placeholder-gray-400 transition-all">
    <button onclick="register()" class="btn-primary w-full p-4 rounded-xl font-bold text-lg shadow-lg relative z-10">
      Entrar al Juego
    </button>
  </div>
</div>

<div style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
  <button onclick="logout()" style="padding: 10px 18px; background: #ff4d4d; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
    Cerrar sesi√≥n
  </button>
</div>

<!-- Men√∫ Principal -->
<div id="mainMenu" class="hidden h-screen flex flex-col bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900">
  <div class="glass-effect p-6 flex items-center justify-between border-b border-white/10">
    <div class="flex items-center space-x-4 overflow-x-auto flex-1">
      <button onclick="showAddFriend()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 w-14 h-14 rounded-full text-3xl flex-shrink-0 shadow-lg hover:shadow-green-500/50 transition-all hover:scale-110 relative z-10">+</button>
      <div id="friendsList" class="flex space-x-4"></div>
    </div>
    <div class="ml-6 peer-id-box px-5 py-3 rounded-xl relative overflow-hidden">
      <div class="text-xs text-gray-400 mb-1">Tu ID</div>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
        <span id="myPeerId" class="text-blue-400 font-mono font-bold text-sm"></span>
      </div>
    </div>
  </div>

  <div class="flex-1 overflow-y-auto p-10">
    <h2 class="text-4xl font-black mb-8 bg-gradient-to-r from-white to-gray-400 bg-clip-text text-transparent">Juegos Populares</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8">
      <div class="game-card bg-gray-800 rounded-2xl overflow-hidden cursor-pointer shadow-xl" onclick="selectGame('obby')">
        <div class="h-64 bg-gradient-to-br from-green-400 via-emerald-500 to-teal-600 flex items-center justify-center text-8xl relative">
          üèÉ<div class="absolute inset-0 bg-black/20"></div>
        </div>
        <div class="p-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-2xl font-bold">Obby Extremo</h3>
            <span class="bg-green-500 text-white text-xs px-3 py-1 rounded-full font-bold">NUEVO</span>
          </div>
          <p class="text-gray-400 text-sm mb-4">¬°Salta y completa el recorrido de obst√°culos!</p>
        </div>
      </div>
      
      <div class="game-card bg-gray-800 rounded-2xl overflow-hidden cursor-pointer shadow-xl" onclick="selectGame('shooter')">
        <div class="h-64 bg-gradient-to-br from-red-400 via-orange-500 to-yellow-600 flex items-center justify-center text-8xl relative">
          üî´<div class="absolute inset-0 bg-black/20"></div>
        </div>
        <div class="p-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-2xl font-bold">Shooter Arena</h3>
            <span class="bg-red-500 text-white text-xs px-3 py-1 rounded-full font-bold">POPULAR</span>
          </div>
          <p class="text-gray-400 text-sm mb-4">¬°Dispara y sobrevive en la arena de batalla!</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal A√±adir Amigo -->
<div id="addFriendModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 modal-backdrop">
  <div class="glass-effect p-8 rounded-3xl w-[450px] modal-content">
    <h2 class="text-3xl font-black mb-6 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">A√±adir Amigo</h2>
    <input id="friendPeerInput" type="text" placeholder="ID del peer" class="w-full p-4 mb-6 bg-gray-800/50 rounded-xl border-2 border-gray-700 focus:border-blue-500 text-white placeholder-gray-400 transition-all">
    <div class="flex space-x-3">
      <button onclick="addFriend()" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 p-4 rounded-xl font-bold shadow-lg transition-all hover:scale-105 relative z-10">A√±adir</button>
      <button onclick="hideAddFriend()" class="flex-1 bg-gray-700 hover:bg-gray-600 p-4 rounded-xl font-bold transition-all hover:scale-105">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal Chat Prompt -->
<div id="chatPromptModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 modal-backdrop">
  <div class="glass-effect p-8 rounded-3xl w-[450px] modal-content">
    <h2 class="text-2xl font-black mb-4 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">Chat con <span id="chatPromptName"></span></h2>
    <p class="text-gray-300 mb-6">¬øQuieres abrir el chat con este amigo?</p>
    <div class="flex space-x-3">
      <button onclick="openChatFromPrompt()" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 p-4 rounded-xl font-bold shadow-lg transition-all hover:scale-105 relative z-10">S√≠, chatear</button>
      <button onclick="closeChatPrompt()" class="flex-1 bg-gray-700 hover:bg-gray-600 p-4 rounded-xl font-bold transition-all hover:scale-105">Cancelar</button>
    </div>
  </div>
</div>

<!-- Ventana de Chat -->
<div id="chatWindow" class="hidden fixed top-20 right-6 w-96 h-[600px] glass-effect rounded-2xl shadow-2xl z-40 flex flex-col">
  <div class="p-4 border-b border-white/10 flex items-center justify-between">
    <div class="flex items-center space-x-3">
      <div id="chatFriendAvatar" class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center font-bold"></div>
      <div>
        <div id="chatFriendName" class="font-bold"></div>
        <div id="chatFriendStatus" class="text-xs text-gray-400"></div>
      </div>
    </div>
    <button onclick="closeChat()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
  </div>
  
  <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin"></div>
  
  <div class="p-4 border-t border-white/10">
    <div id="mediaPreview" class="hidden mb-2 p-2 bg-gray-700/50 rounded-lg"></div>
    <div class="flex space-x-2 mb-2">
      <input type="file" id="fileInput" accept="image/*,video/*,*" class="hidden" onchange="handleFileSelect(event)">
      <button onclick="document.getElementById('fileInput').click()" class="bg-gray-700 hover:bg-gray-600 p-2 rounded-lg transition-all" title="Adjuntar archivo">üìé</button>
    </div>
    <div class="flex space-x-2">
      <input id="chatInput" type="text" placeholder="Escribe un mensaje..." class="flex-1 p-3 bg-gray-800/50 rounded-xl border-2 border-gray-700 focus:border-blue-500 text-white placeholder-gray-400 transition-all" onkeypress="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 px-6 rounded-xl font-bold transition-all">Enviar</button>
    </div>
  </div>
</div>

<!-- Lobby del Juego -->
<div id="gameLobby" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-40 modal-backdrop">
  <div class="glass-effect p-10 rounded-3xl w-2/3 max-w-4xl modal-content">
    <h2 id="gameTitle" class="text-4xl font-black mb-8 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent"></h2>
    <div id="friendSelection" class="mb-8">
      <h3 class="text-xl font-bold mb-4 text-gray-300">Selecciona amigos para invitar:</h3>
      <div id="selectableFriends" class="space-y-3"></div>
    </div>
    <button onclick="startLobby()" class="btn-primary w-full p-5 rounded-xl font-bold text-xl shadow-lg mb-3 relative z-10">üéÆ Crear Sala</button>
    <button onclick="closeLobby()" class="w-full bg-gray-700 hover:bg-gray-600 p-4 rounded-xl font-bold transition-all">Volver</button>
  </div>
</div>

<!-- Sala de Espera -->
<div id="waitingRoom" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-40 modal-backdrop">
  <div class="glass-effect p-10 rounded-3xl w-2/3 max-w-4xl modal-content">
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-4xl font-black bg-gradient-to-r from-green-400 to-emerald-500 bg-clip-text text-transparent">Sala de Espera</h2>
      <div class="flex items-center space-x-2 bg-green-500/20 px-4 py-2 rounded-full">
        <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
        <span class="text-green-400 font-bold">En espera</span>
      </div>
    </div>
    <div id="playersList" class="mb-8 space-y-3"></div>
    <button onclick="startGame()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 p-5 rounded-xl font-bold text-xl shadow-lg transition-all hover:scale-105 mb-3 relative z-10">üöÄ ¬°Empezar Juego!</button>
    <button onclick="cancelRoom()" class="w-full bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 p-4 rounded-xl font-bold transition-all">Cancelar</button>
  </div>
</div>

<!-- Notificaci√≥n de Invitaci√≥n -->
<div id="inviteNotification" class="hidden fixed top-6 right-6 glass-effect p-6 rounded-2xl shadow-2xl z-50 w-96 notification-enter border-2 border-blue-500/30">
  <div class="flex items-center mb-3">
    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-2xl mr-3">üéÆ</div>
    <h3 class="font-bold text-lg">Invitaci√≥n de Juego</h3>
  </div>
  <p id="inviteText" class="mb-4 text-sm text-gray-300"></p>
  <div class="flex space-x-3">
    <button onclick="acceptInvite()" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 p-3 rounded-xl font-bold transition-all hover:scale-105 relative z-10">‚úì Aceptar</button>
    <button onclick="declineInvite()" class="flex-1 bg-gray-700 hover:bg-gray-600 p-3 rounded-xl font-bold transition-all">‚úó Rechazar</button>
  </div>
</div>

<!-- Canvas del Juego -->
<div id="gameScreen" class="hidden game-canvas">
  <div id="mobileControls" class="fixed bottom-8 left-0 right-0 flex justify-between px-8 z-50">
    <div class="flex flex-col items-center space-y-3">
      <button id="btnUp" class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-3xl font-bold shadow-xl border-2 border-white/30 active:bg-white/40 transition-all">‚ñ≤</button>
      <div class="flex space-x-3">
        <button id="btnLeft" class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-3xl font-bold shadow-xl border-2 border-white/30 active:bg-white/40 transition-all">‚óÑ</button>
        <button id="btnDown" class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-3xl font-bold shadow-xl border-2 border-white/30 active:bg-white/40 transition-all">‚ñº</button>
        <button id="btnRight" class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-3xl font-bold shadow-xl border-2 border-white/30 active:bg-white/40 transition-all">‚ñ∫</button>
      </div>
    </div>
    <div class="flex flex-col items-center space-y-3">
      <button id="btnShoot" class="w-20 h-20 bg-red-500/80 backdrop-blur-md rounded-full flex items-center justify-center text-3xl font-bold shadow-xl border-2 border-red-300/30 active:bg-red-600 transition-all">üî´</button>
      <button id="btnJump" class="w-16 h-16 bg-green-500/80 backdrop-blur-md rounded-full flex items-center justify-center text-2xl font-bold shadow-xl border-2 border-green-300/30 active:bg-green-600 transition-all">‚¨Ü</button>
    </div>
  </div>
</div>

<script>
let userData = { username: '', peerId: '', loggedIn: false };
let friends = [];
let chats = {};
let peer = null;
let connections = {};
let currentGame = null;
let selectedFriends = [];
let roomPlayers = [];
let isHost = false;
let currentInvite = null;
let currentChatFriend = null;
let pendingMedia = null;

// Three.js variables
let scene, camera, renderer, playerMesh, remotePlayers = {}, keys = {};

window.addEventListener('load', loadSavedData);

function loadSavedData() {
  try {
    const savedUser = localStorage.getItem('userData');
    const savedFriends = localStorage.getItem('friends');
    const savedChats = localStorage.getItem('chats');
    if (savedUser) userData = JSON.parse(savedUser);
    if (savedFriends) friends = JSON.parse(savedFriends);
    if (savedChats) chats = JSON.parse(savedChats);
    if (userData.loggedIn) {
      initPeer();
      showMainMenu();
    }
  } catch(e) { console.error('Error loading:', e); }
}

function saveData() {
  try {
    localStorage.setItem('userData', JSON.stringify(userData));
    localStorage.setItem('friends', JSON.stringify(friends));
    localStorage.setItem('chats', JSON.stringify(chats));
  } catch(e) { console.error('Error saving:', e); }
}

function register() {
  const username = document.getElementById('usernameInput').value.trim();
  if (!username) return alert('Ingresa un nombre de usuario');
  userData.username = username;
  userData.loggedIn = true;
  saveData();
  initPeer();
}

function initPeer() {
  if (!userData.peerId) userData.peerId = 'user_' + Math.random().toString(36).substr(2, 9);
  peer = new Peer(userData.peerId);
  peer.on('open', (id) => {
    userData.peerId = id;
    document.getElementById('myPeerId').textContent = id;
    saveData();
    showMainMenu();
    reconnectToFriends();
  });
  peer.on('connection', setupConnection);
  peer.on('error', (err) => {
    console.error('Peer error:', err);
    if (err.type === 'unavailable-id') {
      userData.peerId = 'user_' + Math.random().toString(36).substr(2, 9);
      peer = new Peer(userData.peerId);
    }
  });
}

function reconnectToFriends() {
  friends.forEach(f => { if (!connections[f.peerId]) connectToFriend(f.peerId); });
}

function setupConnection(conn) {
  connections[conn.peer] = conn;
  conn.on('open', () => conn.send({ type: 'handshake', username: userData.username, peerId: userData.peerId }));
  conn.on('data', (data) => handleMessage(data, conn.peer));
  conn.on('close', () => updateFriendStatus(conn.peer, false));
}

function handleMessage(data, fromPeer) {
  switch(data.type) {
    case 'handshake':
      const friend = friends.find(f => f.peerId === fromPeer);
      if (friend) { friend.username = data.username; friend.online = true; updateFriendsDisplay(); }
      break;
    case 'chatMessage': receiveChatMessage(fromPeer, data); break;
    case 'invite': showInviteNotification(data); break;
    case 'accept': addPlayerToRoom(data.username, fromPeer); break;
    case 'start': joinGame(data.game); break;
    case 'playerMove': updateRemotePlayer(fromPeer, data.position, data.rotation); break;
    case 'shoot': createRemoteBullet(fromPeer, data.position, data.direction); break;
  }
}

function showMainMenu() {
  document.getElementById('registerScreen').classList.add('hidden');
  document.getElementById('mainMenu').classList.remove('hidden');
  updateFriendsDisplay();
}

function showAddFriend() { document.getElementById('addFriendModal').classList.remove('hidden'); }
function hideAddFriend() { document.getElementById('addFriendModal').classList.add('hidden'); document.getElementById('friendPeerInput').value = ''; }

function addFriend() {
  const peerId = document.getElementById('friendPeerInput').value.trim();
  if (!peerId) return alert('Ingresa un ID de peer');
  if (peerId === userData.peerId) return alert('No puedes a√±adirte a ti mismo');
  if (friends.find(f => f.peerId === peerId)) return alert('Ya es tu amigo');
  friends.push({ peerId, username: peerId.split('_')[1], online: false });
  chats[peerId] = [];
  connectToFriend(peerId);
  updateFriendsDisplay();
  saveData();
  hideAddFriend();
}

function connectToFriend(peerId) {
  if (connections[peerId]) return;
  const conn = peer.connect(peerId);
  setupConnection(conn);
}

function updateFriendStatus(peerId, online) {
  const friend = friends.find(f => f.peerId === peerId);
  if (friend) { friend.online = online; updateFriendsDisplay(); }
}

function updateFriendsDisplay() {
  const list = document.getElementById('friendsList');
  list.innerHTML = friends.map(f => `
    <div class="flex flex-col items-center" onclick="showChatPrompt('${f.peerId}')">
      <div class="friend-avatar ${f.online ? 'online' : 'offline'} w-14 h-14 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xl font-bold shadow-lg">
        ${f.username[0].toUpperCase()}
      </div>
      <div class="text-xs mt-2 font-semibold">${f.username}</div>
    </div>
  `).join('');
}

// Chat
function showChatPrompt(peerId) {
  const friend = friends.find(f => f.peerId === peerId);
  if (!friend) return;
  currentChatFriend = peerId;
  document.getElementById('chatPromptName').textContent = friend.username;
  document.getElementById('chatPromptModal').classList.remove('hidden');
}

function closeChatPrompt() { document.getElementById('chatPromptModal').classList.add('hidden'); currentChatFriend = null; }
function openChatFromPrompt() { if (!currentChatFriend) return; openChat(currentChatFriend); closeChatPrompt(); }

function openChat(peerId) {
  const friend = friends.find(f => f.peerId === peerId);
  if (!friend) return;
  currentChatFriend = peerId;
  document.getElementById('chatFriendAvatar').textContent = friend.username[0].toUpperCase();
  document.getElementById('chatFriendName').textContent = friend.username;
  document.getElementById('chatFriendStatus').textContent = friend.online ? 'En l√≠nea' : 'Desconectado';
  if (!chats[peerId]) chats[peerId] = [];
  displayChatMessages();
  document.getElementById('chatWindow').classList.remove('hidden');
}

function closeChat() {
  document.getElementById('chatWindow').classList.add('hidden');
  currentChatFriend = null;
  pendingMedia = null;
  document.getElementById('mediaPreview').classList.add('hidden');
  document.getElementById('mediaPreview').innerHTML = '';
}

function displayChatMessages() {
  const container = document.getElementById('chatMessages');
  const messages = chats[currentChatFriend] || [];
  container.innerHTML = messages.map(msg => {
    const isMine = msg.from === userData.peerId;
    const time = new Date(msg.timestamp).toLocaleTimeString('es', {hour: '2-digit', minute: '2-digit'});
    let content = '';
    if (msg.type === 'text') content = `<p>${msg.message}</p>`;
    else if (msg.type === 'image') content = `<img src="${msg.mediaData}" class="chat-media" alt="Imagen">`;
    else if (msg.type === 'video') content = `<video src="${msg.mediaData}" class="chat-media" controls></video>`;
    else if (msg.type === 'file') content = `<a href="${msg.mediaData}" download="${msg.fileName}" class="text-blue-400 hover:underline">üìé ${msg.fileName}</a>`;
    return `<div class="chat-message ${isMine ? 'mine' : 'theirs'} p-3 rounded-xl">${content}<div class="text-xs opacity-70 mt-1">${time}</div></div>`;
  }).join('');
  container.scrollTop = container.scrollHeight;
}

function handleFileSelect(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const mediaData = e.target.result;
    let type = 'file';
    if (file.type.startsWith('image/')) type = 'image';
    else if (file.type.startsWith('video/')) type = 'video';
    pendingMedia = { type, mediaData, fileName: file.name };
    const preview = document.getElementById('mediaPreview');
    if (type === 'image') preview.innerHTML = `<img src="${mediaData}" class="max-h-20 rounded">`;
    else if (type === 'video') preview.innerHTML = `<video src="${mediaData}" class="max-h-20 rounded"></video>`;
    else preview.innerHTML = `<div class="text-sm">üìé ${file.name}</div>`;
    preview.classList.remove('hidden');
  };
  reader.readAsDataURL(file);
}

function sendMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message && !pendingMedia) return;
  if (!currentChatFriend) return;
  const msgData = {
    from: userData.peerId,
    timestamp: Date.now(),
    type: pendingMedia ? pendingMedia.type : 'text',
    message: message,
    mediaData: pendingMedia ? pendingMedia.mediaData : null,
    fileName: pendingMedia ? pendingMedia.fileName : null
  };
  if (!chats[currentChatFriend]) chats[currentChatFriend] = [];
  chats[currentChatFriend].push(msgData);
  saveData();
  if (connections[currentChatFriend]) connections[currentChatFriend].send({ type: 'chatMessage', ...msgData });
  input.value = '';
  pendingMedia = null;
  document.getElementById('mediaPreview').classList.add('hidden');
  document.getElementById('mediaPreview').innerHTML = '';
  document.getElementById('fileInput').value = '';
  displayChatMessages();
}

function receiveChatMessage(fromPeer, data) {
  if (!chats[fromPeer]) chats[fromPeer] = [];
  chats[fromPeer].push({
    from: fromPeer,
    timestamp: data.timestamp,
    type: data.type,
    message: data.message,
    mediaData: data.mediaData,
    fileName: data.fileName
  });
  saveData();
  if (currentChatFriend === fromPeer) displayChatMessages();
}

// Game System
function selectGame(game) {
  currentGame = game;
  const titles = { obby: 'üèÉ Obby Extremo', shooter: 'üî´ Shooter Arena' };
  document.getElementById('gameTitle').textContent = titles[game];
  const selectable = document.getElementById('selectableFriends');
  selectable.innerHTML = friends.filter(f => f.online).map(f => `
    <label class="flex items-center space-x-3 cursor-pointer bg-gray-700/50 p-4 rounded-xl hover:bg-gray-700 transition-all">
      <input type="checkbox" value="${f.peerId}" class="w-5 h-5 accent-blue-500">
      <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center font-bold">${f.username[0].toUpperCase()}</div>
      <span class="font-semibold">${f.username}</span>
    </label>
  `).join('');
  document.getElementById('gameLobby').classList.remove('hidden');
}

function closeLobby() { document.getElementById('gameLobby').classList.add('hidden'); currentGame = null; selectedFriends = []; }

function startLobby() {
  const checks = document.querySelectorAll('#selectableFriends input:checked');
  selectedFriends = Array.from(checks).map(c => c.value);
  isHost = true;
  roomPlayers = [{ username: userData.username, peerId: userData.peerId }];
  selectedFriends.forEach(peerId => {
    if (connections[peerId]) connections[peerId].send({ type: 'invite', game: currentGame, host: userData.username });
  });
  document.getElementById('gameLobby').classList.add('hidden');
  showWaitingRoom();
}

function showWaitingRoom() { document.getElementById('waitingRoom').classList.remove('hidden'); updatePlayersList(); }

function updatePlayersList() {
  const list = document.getElementById('playersList');
  list.innerHTML = roomPlayers.map(p => `
    <div class="glass-effect p-4 rounded-xl flex items-center hover:bg-white/5 transition-all">
      <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center mr-4 font-bold text-lg shadow-lg">${p.username[0].toUpperCase()}</div>
      <span class="font-semibold text-lg">${p.username}</span>
      <div class="ml-auto flex items-center space-x-2 bg-green-500/20 px-3 py-1 rounded-full">
        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
        <span class="text-green-400 text-xs font-bold">Listo</span>
      </div>
    </div>
  `).join('');
}

function addPlayerToRoom(username, peerId) {
  if (!roomPlayers.find(p => p.peerId === peerId)) { roomPlayers.push({ username, peerId }); updatePlayersList(); }
}

function cancelRoom() { document.getElementById('waitingRoom').classList.add('hidden'); roomPlayers = []; isHost = false; }

function showInviteNotification(data) {
  currentInvite = data;
  document.getElementById('inviteText').textContent = `${data.host} te invita a jugar ${data.game === 'obby' ? 'Obby Extremo' : 'Shooter Arena'}`;
  document.getElementById('inviteNotification').classList.remove('hidden');
}

function acceptInvite() {
  if (currentInvite) {
    Object.values(connections).forEach(conn => conn.send({ type: 'accept', username: userData.username }));
    currentGame = currentInvite.game;
  }
  document.getElementById('inviteNotification').classList.add('hidden');
}

function declineInvite() { document.getElementById('inviteNotification').classList.add('hidden'); currentInvite = null; }

function startGame() {
  roomPlayers.forEach(p => { if (connections[p.peerId]) connections[p.peerId].send({ type: 'start', game: currentGame }); });
  joinGame(currentGame);
}

// Three.js Game
function joinGame(game) {
  document.getElementById('mainMenu').classList.add('hidden');
  document.getElementById('waitingRoom').classList.add('hidden');
  document.getElementById('gameScreen').classList.remove('hidden');
  setupMobileControls();
  if (game === 'obby') initObby3D();
  else initShooter3D();
}

function initObby3D() {
  const container = document.getElementById('gameScreen');
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87ceeb);
  scene.fog = new THREE.Fog(0x87ceeb, 50, 200);
  
  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 10, 20);
  
  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.shadowMap.enabled = true;
  container.appendChild(renderer.domElement);
  
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(10, 20, 10);
  light.castShadow = true;
  scene.add(light);
  scene.add(new THREE.AmbientLight(0x404040, 0.5));
  
  // Plataformas
  const platforms = [
    { x: 0, y: 0, z: 0, w: 10, h: 1, d: 10 },
    { x: 15, y: 2, z: 0, w: 8, h: 1, d: 8 },
    { x: 30, y: 5, z: 0, w: 8, h: 1, d: 8 },
    { x: 45, y: 8, z: 0, w: 10, h: 1, d: 10 }
  ];
  
  platforms.forEach(p => {
    const geo = new THREE.BoxGeometry(p.w, p.h, p.d);
    const mat = new THREE.MeshStandardMaterial({ color: 0x10b981 });
    const mesh = new THREE.Mesh(geo, mat);
    mesh.position.set(p.x, p.y, p.z);
    mesh.castShadow = true;
    mesh.receiveShadow = true;
    scene.add(mesh);
  });
  
  // Player
  const playerGeo = new THREE.BoxGeometry(1, 2, 1);
  const playerMat = new THREE.MeshStandardMaterial({ color: 0x3b82f6 });
  playerMesh = new THREE.Mesh(playerGeo, playerMat);
  playerMesh.position.set(0, 2, 0);
  playerMesh.castShadow = true;
  scene.add(playerMesh);
  
  // Remote players
  roomPlayers.forEach(p => {
    if (p.peerId !== userData.peerId) createRemotePlayer3D(p.username);
  });
  
  animate3D();
}

function initShooter3D() {
  const container = document.getElementById('gameScreen');
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x1e293b);
  
  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 5, 10);
  
  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.shadowMap.enabled = true;
  container.appendChild(renderer.domElement);
  
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(10, 20, 10);
  light.castShadow = true;
  scene.add(light);
  scene.add(new THREE.AmbientLight(0x404040, 0.5));
  
  // Floor
  const floorGeo = new THREE.PlaneGeometry(100, 100);
  const floorMat = new THREE.MeshStandardMaterial({ color: 0x334155 });
  const floor = new THREE.Mesh(floorGeo, floorMat);
  floor.rotation.x = -Math.PI / 2;
  floor.receiveShadow = true;
  scene.add(floor);
  
  // Player
  const playerGeo = new THREE.BoxGeometry(1, 2, 1);
  const playerMat = new THREE.MeshStandardMaterial({ color: 0x3b82f6 });
  playerMesh = new THREE.Mesh(playerGeo, playerMat);
  playerMesh.position.set(0, 1, 0);
  playerMesh.castShadow = true;
  scene.add(playerMesh);
  
  // Remote players
  roomPlayers.forEach(p => {
    if (p.peerId !== userData.peerId) createRemotePlayer3D(p.username);
  });
  
  animate3D();
}

function createRemotePlayer3D(username) {
  const geo = new THREE.BoxGeometry(1, 2, 1);
  const mat = new THREE.MeshStandardMaterial({ color: 0xf59e0b });
  const mesh = new THREE.Mesh(geo, mat);
  mesh.position.set(Math.random() * 10 - 5, 1, Math.random() * 10 - 5);
  mesh.castShadow = true;
  scene.add(mesh);
  remotePlayers[username] = { mesh, label: null };
  
  const label = document.createElement('div');
  label.className = 'player-label';
  label.textContent = username;
  document.getElementById('gameScreen').appendChild(label);
  remotePlayers[username].label = label;
}

function updateRemotePlayer(peerId, position, rotation) {
  const friend = friends.find(f => f.peerId === peerId);
  if (friend && remotePlayers[friend.username]) {
    remotePlayers[friend.username].mesh.position.set(position.x, position.y, position.z);
    if (rotation) remotePlayers[friend.username].mesh.rotation.y = rotation.y;
  }
}

function animate3D() {
  requestAnimationFrame(animate3D);
  
  if (playerMesh) {
    const speed = 0.2;
    if (keys['w'] || keys['W'] || keys['ArrowUp']) playerMesh.position.z -= speed;
    if (keys['s'] || keys['S'] || keys['ArrowDown']) playerMesh.position.z += speed;
    if (keys['a'] || keys['A'] || keys['ArrowLeft']) playerMesh.position.x -= speed;
    if (keys['d'] || keys['D'] || keys['ArrowRight']) playerMesh.position.x += speed;
    
    camera.position.x = playerMesh.position.x;
    camera.position.z = playerMesh.position.z + 10;
    camera.lookAt(playerMesh.position);
    
    // Send position
    Object.values(connections).forEach(conn => {
      conn.send({ 
        type: 'playerMove', 
        position: { x: playerMesh.position.x, y: playerMesh.position.y, z: playerMesh.position.z },
        rotation: { y: playerMesh.rotation.y }
      });
    });
    
    // Update labels
    Object.values(remotePlayers).forEach(rp => {
      if (rp.label) {
        const pos = rp.mesh.position.clone().project(camera);
        pos.x = (pos.x * 0.5 + 0.5) * window.innerWidth;
        pos.y = (-(pos.y * 0.5) + 0.5) * window.innerHeight - 40;
        rp.label.style.left = pos.x + 'px';
        rp.label.style.top = pos.y + 'px';
      }
    });
  }
  
  renderer.render(scene, camera);
}

function createRemoteBullet(peerId, position, direction) {
  if (!scene) return;
  const geo = new THREE.SphereGeometry(0.2);
  const mat = new THREE.MeshBasicMaterial({ color: 0xfbbf24 });
  const bullet = new THREE.Mesh(geo, mat);
  bullet.position.set(position.x, position.y, position.z);
  scene.add(bullet);
  
  const vel = new THREE.Vector3(direction.x, direction.y, direction.z).normalize().multiplyScalar(0.5);
  let life = 100;
  const updateBullet = () => {
    bullet.position.add(vel);
    life--;
    if (life > 0) requestAnimationFrame(updateBullet);
    else { scene.remove(bullet); bullet.geometry.dispose(); bullet.material.dispose(); }
  };
  updateBullet();
}

document.addEventListener('keydown', (e) => {
  keys[e.key] = true;
  keys[e.key.toLowerCase()] = true;
  if (e.key === ' ' && currentGame === 'shooter') {
    e.preventDefault();
    const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
    Object.values(connections).forEach(conn => {
      conn.send({ type: 'shoot', position: playerMesh.position, direction: dir });
    });
    createRemoteBullet(userData.peerId, playerMesh.position, dir);
  }
});

document.addEventListener('keyup', (e) => {
  keys[e.key] = false;
  keys[e.key.toLowerCase()] = false;
});

function setupMobileControls() {
  ['btnUp', 'btnDown', 'btnLeft', 'btnRight', 'btnShoot', 'btnJump'].forEach(id => {
    const btn = document.getElementById(id);
    const key = { btnUp: 'w', btnDown: 's', btnLeft: 'a', btnRight: 'd', btnJump: 'w' }[id];
    if (key) {
      btn.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
      btn.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
      btn.addEventListener('mousedown', () => keys[key] = true);
      btn.addEventListener('mouseup', () => keys[key] = false);
    }
    if (id === 'btnShoot') {
      btn.addEventListener('click', () => {
        if (currentGame === 'shooter' && playerMesh) {
          const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
          Object.values(connections).forEach(conn => {
            conn.send({ type: 'shoot', position: playerMesh.position, direction: dir });
          });
          createRemoteBullet(userData.peerId, playerMesh.position, dir);
        }
      });
    }
  });
}

window.addEventListener('resize', () => {
  if (camera && renderer) {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }
});

function logout() {
  localStorage.clear();
  location.reload();
}
</script>

</body>
</html>
